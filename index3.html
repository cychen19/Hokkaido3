<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—æµ·é“ä»»æ„é–€ (å“†å•¦Aå¤¢ç‰ˆ) ğŸ‚</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Doraemon & Sakura Theme Colors */
        :root {
            --dora-blue: #0096FF; /* å“†å•¦è— */
            --dora-red: #E60033;  /* å“†å•¦ç´… (é …åœˆ/é¼»å­) */
            --sakura-pink: #FFB7C5; /* æ«»èŠ±ç²‰ */
            --sakura-dark: #FB6F92;
            --bg-color: #FFF0F5;  /* æ·ºç²‰ç´…èƒŒæ™¯ */
        }

        body {
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Sakura Animation */
        .sakura {
            position: fixed;
            top: -10px;
            z-index: 0;
            color: #FFB7C5;
            font-size: 1.2em;
            opacity: 0.8;
            pointer-events: none;
            animation: fall linear infinite;
            text-shadow: 0 0 5px rgba(255, 183, 197, 0.5);
        }

        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0) rotate(0deg); opacity: 0.8; }
            100% { transform: translateY(110vh) translateX(20px) rotate(360deg); opacity: 0; }
        }

        /* Custom Scrollbar */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animations */
        .zoom-in { animation: zoomIn 0.3s ease-out forwards; }
        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Data: åŒ—æµ·é“è¡Œç¨‹ (å®Œæ•´è³‡æ–™) ---
        const initialSchedule = [
            {
                day: 1, date: '4/22 (ä¸‰)', loc: 'chitose', city: 'æ–°åƒæ­²/çƒå ´',
                events: [
                    { time: '16:00', type: 'car', title: 'æ©Ÿå ´å‡ºé—œ', desc: 'æŠµé”åŒ—æµ·é“', note: '' },
                    { time: '16:00-16:30', type: 'car', title: 'å‰å¾€åƒæ­²ç«™', desc: '', note: '' },
                    { time: '16:30-17:00', type: 'package', title: 'å¯„æ”¾è¡Œæ', desc: 'åƒæ­²ç«™ç½®ç‰©æ«ƒ', note: '' },
                    { time: '17:00-17:30', type: 'car', title: 'åƒæ­²ç«™åˆ°çƒå ´', desc: '', note: '' },
                    { time: '18:00-21:30', type: 'trophy', title: 'ES CON FIELD', desc: 'æ—¥æœ¬æœ€æ–°çƒå ´ï¼Œå…§æœ‰æº«æ³‰æ¡‘æ‹¿ç¾é£Ÿ', note: 'çƒå ´åƒè§€/çœ‹çƒ' },
                    { time: '21:30-22:10', type: 'moon', title: 'å‰å¾€é£¯åº—', desc: 'ä¼‘æ¯', note: '' },
                    { time: 'Check-in', type: 'bed', title: 'JR INN', desc: 'hotel.com å·²ä»˜æ¬¾', note: '' }
                ]
            },
            {
                day: 2, date: '4/23 (å››)', loc: 'noboribetsu', city: 'ç™»åˆ¥æº«æ³‰',
                events: [
                    { time: '09:30', type: 'car', title: 'é£¯åº—å‡ºç™¼', desc: '', note: '' },
                    { time: '10:30', type: 'car', title: 'æ©Ÿå ´å–è»Šå‡ºç™¼', desc: 'âš ï¸ æª¢æŸ¥ ETC å¡', note: '' },
                    { time: '11:00-14:00', type: 'shopping-bag', title: 'ä¸‰äº• Outlet Park', desc: 'åœ¨æ­¤åˆé¤', note: '' },
                    { time: '14:00-15:15', type: 'car', title: 'å‰å¾€ç™»åˆ¥', desc: 'é“å¤®è‡ªå‹•è»Šé“', note: '' },
                    { time: '15:15-16:15', type: 'flame', title: 'ç™»åˆ¥åœ°ç„è°·', desc: 'ç›´å¾‘450mçˆ†è£‚ç«å±±å£ï¼Œå……æ»¿ç¡«ç£ºå‘³ï¼Œæ„Ÿå—å¤§åœ°éœ‡æ’¼ã€‚', note: 'å¿…æ‹' },
                    { time: '16:30', type: 'coffee', title: 'è¾¦ç†å…¥ä½', desc: 'äº«å—æº«æ³‰æ™šé¤', note: '' },
                    { time: 'Check-in', type: 'bed', title: 'ç™»åˆ¥ Grand Hotel', desc: 'agoda å·²ä»˜', note: '' }
                ]
            },
            {
                day: 3, date: '4/24 (äº”)', loc: 'hakodate', city: 'å‡½é¤¨',
                events: [
                    { time: '09:30', type: 'car', title: 'é€€æˆ¿ â†’ æ´çˆºæ¹–', desc: '', note: '' },
                    { time: '10:30-11:30', type: 'camera', title: 'æ´çˆºæ¹–è³½ç¾…å±•æœ›å°', desc: 'Silo Platformï¼Œä¿¯ç°ä¸­å³¶ã€æ˜­å’Œæ–°å±±æœ€ä½³é»ã€‚', note: '' },
                    { time: '11:30-13:30', type: 'car', title: 'ç§»å‹•å¾€å‡½é¤¨', desc: 'ç´„2å°æ™‚è»Šç¨‹', note: '' },
                    { time: '13:30-14:30', type: 'utensils', title: 'å°ä¸‘æ¼¢å ¡ (å³ ä¸‹ç¸½æœ¬åº—)', desc: 'å‡½é¤¨éˆé­‚ç¾é£Ÿï¼Œå¿…é»ä¸­è¯é›è‚‰æ¼¢å ¡ã€‚', note: 'Tel: 0138-66-6788' },
                    { time: '15:00-16:30', type: 'flower', title: 'äº”ç¨œéƒ­å…¬åœ’', desc: 'æ˜Ÿå½¢è¦å¡éºè·¡ï¼Œç²‰ç´…æ«»èŠ±æµ·ã€‚', note: 'è³æ«»' },
                    { time: '17:30-19:00', type: 'utensils', title: 'æˆå‰æ€æ±— å¤§é–€', desc: 'åœ¨åœ°è€åº—ï¼Œåšåˆ‡ç¾Šè‚‰ã€‚', note: 'â˜…éœ€é ç´„' },
                    { time: '19:30', type: 'star', title: 'å‡½é¤¨å±±å¤œæ™¯', desc: 'ä¸–ç•Œä¸‰å¤§å¤œæ™¯ï¼Œé›™Cæµ·ç£åœ°å½¢ã€‚', note: 'çºœè»Š' },
                    { time: 'Check-in', type: 'bed', title: 'Global View Hakodate', desc: 'trip å·²ä»˜', note: '' }
                ]
            },
            {
                day: 4, date: '4/25 (å…­)', loc: 'kutchan', city: 'äºŒä¸–è°·/å®šå±±æºª',
                events: [
                    { time: '08:00', type: 'utensils', title: 'å‡½é¤¨æœå¸‚', desc: 'é«”é©—é‡£æ´»çƒè³Šç¾æ®ºç¾åƒã€‚', note: 'æµ·é®®ä¸¼' },
                    { time: '09:30', type: 'car', title: 'æº–æ™‚å‡ºç™¼', desc: 'é•·é€”ç§»å‹•å¾€äºŒä¸–è°·', note: '' },
                    { time: '12:30-14:00', type: 'coffee', title: 'äºŒä¸–è°· é«˜æ©‹ç‰§å ´', desc: 'ç¾Šè¹„å±±è…³ä¸‹ï¼Œå¿…åƒç‰›å¥¶å†°æ·‡æ·‹ã€æ³¡èŠ™ã€‚', note: 'Tel: 0136-44-3734' },
                    { time: '14:00-15:30', type: 'car', title: 'å‰å¾€å®šå±±æºª', desc: 'ç¶“ä¸­å±±å³ ', note: '' },
                    { time: '16:00', type: 'music', title: 'æ£®ä¹‹æ­Œ Lounge', desc: 'è½è±ç´æ¼”å¥ã€çƒ¤æ£‰èŠ±ç³–ã€‚', note: 'æ£®æ—ç³»' },
                    { time: 'Check-in', type: 'bed', title: 'å®šå±±æºªé¶´é›… æ£®ä¹‹æ­Œ', desc: 'agoda 4/9ä»˜', note: 'Buffetè¶…å¼·' }
                ]
            },
            {
                day: 5, date: '4/26 (æ—¥)', loc: 'otaru', city: 'å°æ¨½',
                events: [
                    { time: '09:30', type: 'car', title: 'é€€æˆ¿ â†’ æ»‘é›ªå ´', desc: '', note: '' },
                    { time: '10:00', type: 'snowflake', title: 'æœ­å¹Œåœ‹éš›æ»‘é›ªå ´', desc: 'æ˜¥å­£æ»‘é›ªé«”é©—ï¼Œé©åˆåˆå­¸è€…ã€‚', note: '' },
                    { time: '11:00-11:45', type: 'car', title: 'å‰å¾€å°æ¨½', desc: '', note: '' },
                    { time: '11:45-12:45', type: 'flower', title: 'æ‰‹å®®å…¬åœ’', desc: 'åŒæ™‚æ‹æ«»èŠ±èˆ‡æµ·æ¸¯çš„ç§˜å¢ƒã€‚', note: '' },
                    { time: '13:00', type: 'utensils', title: 'æ‹‰éºµ Mikan', desc: 'æ¿ƒåšå‘³å™Œååº—ã€‚', note: '' },
                    { time: '14:30', type: 'shopping-bag', title: 'å°æ¨½é‹æ²³ & å ºç”ºé€š', desc: 'å…­èŠ±äº­ã€åŒ—è“æ¨“ã€LeTAOç”œé»å·¡ç¦®ã€‚', note: '' },
                    { time: '17:30', type: 'utensils', title: 'å°æ¨½æµ·é®®/å£½å¸', desc: 'æ¨è–¦ä¼Šå‹¢é®¨æˆ–é­šçœŸã€‚', note: '' },
                    { time: '19:30', type: 'star', title: 'å¤©ç‹—å±±å¤œæ™¯', desc: '', note: '' },
                    { time: 'Check-in', type: 'bed', title: 'Hotel Torifito', desc: 'trip å·²ä»˜', note: '' }
                ]
            },
            {
                day: 6, date: '4/27 (ä¸€)', loc: 'sapporo', city: 'æœ­å¹Œ',
                events: [
                    { time: '09:30', type: 'car', title: 'é€€æˆ¿ â†’ æœ­å¹Œåœ“å±±', desc: '', note: '' },
                    { time: '10:15', type: 'map-pin', title: 'åŒ—æµ·é“ç¥å®®', desc: 'èŠåš´è‚…ç©†ï¼Œå¿…è²·åˆ¤å®˜é¤…ã€‚', note: '' },
                    { time: '12:00', type: 'utensils', title: 'Soup Curry KING', desc: 'åœ¨åœ°Wæ¹¯é ­ååº—ã€‚', note: 'Tel: 011-821-0044' },
                    { time: '14:00', type: 'shopping-bag', title: 'AEON ç™¼å¯’åº—', desc: 'æ¡è²·ä¼´æ‰‹ç¦®ã€è¶…å¸‚é›¶é£Ÿã€‚', note: '' },
                    { time: '17:00', type: 'car', title: 'Check-in / é‚„è»Š', desc: 'ç¢ºèªé£¯åº—åœè»Šä½', note: '' },
                    { time: '18:30', type: 'utensils', title: 'å¤œç©ºæˆå‰æ€æ±—', desc: 'çœ‹æ‘©å¤©è¼ªå¤œæ™¯åƒçƒ¤è‚‰ã€‚', note: 'â˜…å‹™å¿…é ç´„' },
                    { time: 'Check-in', type: 'bed', title: 'Cross Hotel', desc: 'agoda 4/23ä»˜', note: '' }
                ]
            },
            {
                day: 7, date: '4/28 (äºŒ)', loc: 'chitose', city: 'æ­¸é€”',
                events: [
                    { time: '08:30', type: 'car', title: 'é£¯åº—å‡ºç™¼', desc: '', note: '' },
                    { time: '08:30-09:30', type: 'car', title: 'å‡ºç™¼è‡³çƒå ´', desc: '', note: '' },
                    { time: '10:00', type: 'trophy', title: 'çƒå ´å°è¦½', desc: '', note: '' },
                    { time: '12:30', type: 'car', title: 'æŠµé”é‚„è»Šåœ°', desc: '', note: '' },
                    { time: '13:00', type: 'shopping-bag', title: 'æ©Ÿå ´è²·ä¼´æ‰‹ç¦®', desc: '', note: '' },
                    { time: 'End', type: 'home', title: 'ç”œèœœçš„å®¶', desc: '', note: '' }
                ]
            }
        ];

        const weatherLinks = {
            "chitose": "https://tenki.jp/forecast/1/2/1400/1224/",
            "noboribetsu": "https://tenki.jp/forecast/1/4/2100/1205/",
            "hakodate": "https://tenki.jp/forecast/1/3/1800/1202/",
            "kutchan": "https://tenki.jp/forecast/1/3/1720/1400/",
            "otaru": "https://tenki.jp/forecast/1/3/1600/1203/",
            "sapporo": "https://tenki.jp/forecast/1/2/1400/1100/"
        };

        const translationCards = [
            { jp: "ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã€æº€ã‚¿ãƒ³", py: "Regular, Mantan", zh: "95 åŠ æ»¿ (ä¸€èˆ¬æ±½æ²¹)", cat: "åŠ æ²¹", color: "bg-red-500" },
            { jp: "ç¾é‡‘ã§æ‰•ã„ã¾ã™", py: "Genkin de haraimasu", zh: "æˆ‘è¦ç”¨ç¾é‡‘ä»˜", cat: "åŠ æ²¹", color: "bg-green-500" },
            { jp: "é§è»Šå ´ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", py: "Chuushajou wa doko desuka", zh: "åœè»Šå ´åœ¨å“ªï¼Ÿ", cat: "è‡ªé§•", color: "bg-purple-500" },
            { jp: "ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™", py: "Okaikei Onegaishimasu", zh: "æˆ‘è¦çµå¸³", cat: "ç”¨é¤", color: "bg-orange-500" },
            { jp: "ãŠæ°´ãŠé¡˜ã„ã—ã¾ã™", py: "Omizu onegaishimasu", zh: "è«‹çµ¦æˆ‘æ°´", cat: "ç”¨é¤", color: "bg-blue-500" },
            { jp: "è¢‹ã‚’ãã ã•ã„", py: "Fukuro o kudasai", zh: "è«‹çµ¦æˆ‘è¢‹å­", cat: "è³¼ç‰©", color: "bg-pink-500" }
        ];

        // --- Custom Hook for Persistence ---
        function useStickyState(defaultValue, key) {
            const [value, setValue] = useState(() => {
                try {
                    const stickyValue = window.localStorage.getItem(key);
                    return stickyValue !== null && stickyValue !== "undefined" 
                        ? JSON.parse(stickyValue) 
                        : defaultValue;
                } catch (error) {
                    console.error(`Error parsing localStorage key "${key}":`, error);
                    return defaultValue;
                }
            });

            useEffect(() => {
                try {
                    window.localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error(`Error saving localStorage key "${key}":`, error);
                }
            }, [key, value]);

            return [value, setValue];
        }

        // --- Helper Components ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const SakuraBg = () => {
            const flowers = useMemo(() => Array.from({ length: 15 }).map((_, i) => ({
                id: i,
                left: Math.random() * 100 + "vw",
                duration: (Math.random() * 5 + 5) + "s",
                delay: Math.random() * 5 + "s",
                size: (Math.random() * 10 + 15) + "px"
            })), []);

            return (
                <div className="fixed inset-0 pointer-events-none z-0">
                    {flowers.map(f => (
                        <div key={f.id} className="sakura" style={{ left: f.left, animationDuration: f.duration, animationDelay: f.delay, fontSize: f.size }}>ğŸŒ¸</div>
                    ))}
                </div>
            );
        };

        // --- Tabs ---

        // 1. Schedule Tab
        const ScheduleTab = ({ data, setData }) => {
            const [dayIndex, setDayIndex] = useState(0);
            const [isEditing, setIsEditing] = useState(false);

            const handleUpdateEvent = (eIdx, field, value) => {
                setData(prevData => {
                    const newData = [...prevData];
                    newData[dayIndex] = { ...newData[dayIndex], events: [...newData[dayIndex].events] };
                    newData[dayIndex].events[eIdx] = { ...newData[dayIndex].events[eIdx], [field]: value };
                    return newData;
                });
            };

            const openMap = (event) => {
                if (isEditing) return;
                const query = event.mapUrl || `${event.title} åŒ—æµ·é“`; 
                const url = event.mapUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            };

            const currentDay = data[dayIndex];

            return (
                <div className="space-y-4 pb-24 fade-in relative z-10">
                    {/* Day Selector */}
                    <div className="flex overflow-x-auto gap-2 p-2 hide-scrollbar">
                        {data.map((day, idx) => (
                            <button key={idx} onClick={() => setDayIndex(idx)}
                                className={`whitespace-nowrap px-4 py-2 rounded-full font-bold transition-all shadow-lg border-2 ${dayIndex === idx ? 'bg-[#0096FF] text-white border-white' : 'bg-white text-gray-500 border-transparent'}`}>
                                Day {day.day}
                            </button>
                        ))}
                    </div>

                    {/* Header */}
                    <div className="flex justify-between items-center bg-white/90 backdrop-blur rounded-2xl p-4 shadow-lg mx-2 border-l-4 border-[#E60033]">
                        <div>
                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                {currentDay.date}
                                <a href={weatherLinks[currentDay.loc] || "https://tenki.jp/"} target="_blank" className="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full flex items-center gap-1 hover:bg-blue-200">
                                    <Icon name="sun" size={14} /> {currentDay.city}å¤©æ°£
                                </a>
                            </h2>
                        </div>
                        <button onClick={() => setIsEditing(!isEditing)} className={`p-2 rounded-full ${isEditing ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'}`}>
                            <Icon name={isEditing ? "check" : "edit-3"} />
                        </button>
                    </div>

                    {/* Timeline */}
                    <div className="space-y-3 px-2">
                        {currentDay.events.map((event, idx) => (
                            <div key={idx} onClick={() => openMap(event)} className="bg-white/95 backdrop-blur rounded-xl p-4 shadow-md transition-transform active:scale-[0.99] cursor-pointer hover:shadow-lg border border-white">
                                <div className="flex gap-4">
                                    <div className="flex flex-col items-center gap-1 min-w-[50px]">
                                        <div className="bg-blue-50 p-2 rounded-full text-[#0096FF]">
                                            <Icon name={event.type} size={20} />
                                        </div>
                                        {isEditing ? (
                                            <input value={event.time} onChange={(e) => handleUpdateEvent(idx, 'time', e.target.value)} className="w-full text-xs text-center border rounded"/>
                                        ) : (
                                            <span className="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded">{event.time}</span>
                                        )}
                                    </div>
                                    <div className="flex-1 space-y-1">
                                        {isEditing ? (
                                            <div className="space-y-2">
                                                <input value={event.title} onChange={(e) => handleUpdateEvent(idx, 'title', e.target.value)} className="w-full font-bold border rounded p-1" placeholder="æ¨™é¡Œ"/>
                                                <textarea value={event.desc} onChange={(e) => handleUpdateEvent(idx, 'desc', e.target.value)} className="w-full text-sm border rounded p-1" placeholder="èªªæ˜/ä»‹ç´¹"/>
                                                <input value={event.note} onChange={(e) => handleUpdateEvent(idx, 'note', e.target.value)} className="w-full text-xs border rounded p-1" placeholder="å‚™è¨»"/>
                                                <div className="flex items-center gap-1 text-blue-500">
                                                    <Icon name="link" size={12}/>
                                                    <input value={event.mapUrl || ''} onChange={(e) => handleUpdateEvent(idx, 'mapUrl', e.target.value)} className="w-full text-xs border rounded p-1" placeholder="Google Maps URL"/>
                                                </div>
                                            </div>
                                        ) : (
                                            <>
                                                <h3 className="font-bold text-lg text-gray-800">{event.title}</h3>
                                                {event.desc && <p className="text-sm text-gray-600 leading-relaxed">{event.desc}</p>}
                                                {event.note && <div className="bg-pink-50 text-pink-600 text-xs px-2 py-1 rounded inline-block mt-1">ğŸŒ¸ {event.note}</div>}
                                                <div className="text-right text-[10px] text-blue-400 mt-1">{event.mapUrl ? 'ğŸ“å·²è¨­å®šé€£çµ' : 'ğŸ‘†é»æ“Šå°èˆª'}</div>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // 2. Budget Tab (Dual Currency & Split Bill)
        const BudgetTab = ({ expenses, setExpenses }) => {
            const [newItem, setNewItem] = useState({ title: "", amount: "", category: "food", payer: "boy", method: "card", currency: "jpy" });
            const TWD_RATE = 0.22; // é è¨­åŒ¯ç‡

            const addExpense = (e) => {
                e.preventDefault();
                if (!newItem.title || !newItem.amount) return;
                setExpenses(prev => [...prev, { ...newItem, id: Date.now() }]);
                setNewItem({ title: "", amount: "", category: "food", payer: "boy", method: "card", currency: "jpy" });
            };

            const removeExpense = (id) => {
                if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) setExpenses(prev => prev.filter(ex => ex.id !== id));
            };

            const stats = useMemo(() => {
                // 1. å„€è¡¨æ¿è¨ˆç®—
                const cashTotalJPY = expenses.filter(i => i.method === 'cash' && i.currency === 'jpy').reduce((sum, i) => sum + Number(i.amount), 0);
                
                // åˆ·å¡ç¸½é¡ (è‡ªå‹•æ›ç®—åŒ¯ç‡é¡¯ç¤º: TWD + JPY*Rate)
                const cardTotalJPY = expenses.filter(i => i.method === 'card' && i.currency === 'jpy').reduce((sum, i) => sum + Number(i.amount), 0);
                const cardTotalTWD = expenses.filter(i => i.method === 'card' && i.currency === 'twd').reduce((sum, i) => sum + Number(i.amount), 0);
                const displayCardTotalTWD = cardTotalTWD + Math.round(cardTotalJPY * TWD_RATE);

                // 2. åˆ†å¸³è¨ˆç®— (AAåˆ¶) - JPY
                const boyJpy = expenses.filter(i => i.payer === 'boy' && i.currency === 'jpy').reduce((sum, i) => sum + Number(i.amount), 0);
                const girlJpy = expenses.filter(i => i.payer === 'girl' && i.currency === 'jpy').reduce((sum, i) => sum + Number(i.amount), 0);
                const diffJpy = (boyJpy - girlJpy) / 2;

                // 3. åˆ†å¸³è¨ˆç®— (AAåˆ¶) - TWD
                const boyTwd = expenses.filter(i => i.payer === 'boy' && i.currency === 'twd').reduce((sum, i) => sum + Number(i.amount), 0);
                const girlTwd = expenses.filter(i => i.payer === 'girl' && i.currency === 'twd').reduce((sum, i) => sum + Number(i.amount), 0);
                const diffTwd = (boyTwd - girlTwd) / 2;

                return { cashTotalJPY, displayCardTotalTWD, cardTotalJPY, cardTotalTWD, diffJpy, diffTwd };
            }, [expenses]);

            return (
                <div className="space-y-4 pb-24 relative z-10 px-2">
                    {/* Input Card */}
                    <div className="bg-white/95 rounded-2xl p-4 shadow-lg border-t-4 border-[#0096FF]">
                        <h2 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <Icon name="plus-circle" className="text-[#0096FF]" /> æ–°å¢æ”¯å‡º
                        </h2>
                        <form onSubmit={addExpense} className="space-y-3">
                            <div className="flex gap-2">
                                <input className="flex-1 p-2 border rounded bg-gray-50" placeholder="é …ç›®" value={newItem.title} onChange={e => setNewItem({...newItem, title: e.target.value})}/>
                                <select className="w-24 p-2 border rounded bg-gray-50 text-sm" value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})}>
                                    <option value="food">é£²é£Ÿ</option><option value="transport">äº¤é€š</option><option value="shopping">è³¼ç‰©</option><option value="hotel">ä½å®¿</option>
                                </select>
                            </div>
                            <div className="flex gap-2">
                                <input className="flex-1 p-2 border rounded bg-gray-50" type="number" placeholder="é‡‘é¡" value={newItem.amount} onChange={e => setNewItem({...newItem, amount: e.target.value})}/>
                                <div className="flex gap-1">
                                    <button type="button" onClick={() => setNewItem({...newItem, currency: 'twd'})} className={`px-2 rounded border ${newItem.currency === 'twd' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-white'}`}>NT$</button>
                                    <button type="button" onClick={() => setNewItem({...newItem, currency: 'jpy'})} className={`px-2 rounded border ${newItem.currency === 'jpy' ? 'bg-yellow-100 border-yellow-400 text-yellow-700' : 'bg-white'}`}>Â¥</button>
                                </div>
                            </div>
                            <div className="flex gap-2 text-sm">
                                <div className="flex-1 flex gap-1 bg-gray-100 p-1 rounded">
                                    <button type="button" onClick={() => setNewItem({...newItem, payer: 'boy'})} className={`flex-1 rounded ${newItem.payer === 'boy' ? 'bg-blue-500 text-white' : ''}`}>ğŸ‘¦</button>
                                    <button type="button" onClick={() => setNewItem({...newItem, payer: 'girl'})} className={`flex-1 rounded ${newItem.payer === 'girl' ? 'bg-pink-500 text-white' : ''}`}>ğŸ‘§</button>
                                </div>
                                <div className="flex-1 flex gap-1 bg-gray-100 p-1 rounded">
                                    <button type="button" onClick={() => setNewItem({...newItem, method: 'card'})} className={`flex-1 rounded ${newItem.method === 'card' ? 'bg-purple-500 text-white' : ''}`}>ğŸ’³</button>
                                    <button type="button" onClick={() => setNewItem({...newItem, method: 'cash'})} className={`flex-1 rounded ${newItem.method === 'cash' ? 'bg-green-500 text-white' : ''}`}>ğŸ’µ</button>
                                </div>
                            </div>
                            <button className="w-full bg-[#0096FF] text-white py-2 rounded-lg font-bold shadow active:scale-95 transition">åŠ å…¥è¨˜å¸³</button>
                        </form>
                    </div>

                    {/* Summary Cards */}
                    <div className="flex gap-2">
                        <div className="flex-1 bg-gradient-to-br from-green-400 to-green-600 p-3 rounded-xl text-white shadow">
                            <p className="text-xs opacity-90 font-bold">ğŸ’µ ç¾é‡‘ç¸½æ”¯å‡º (JPY)</p>
                            <p className="text-xl font-black">Â¥{stats.cashTotalJPY.toLocaleString()}</p>
                            <p className="text-[10px] opacity-80">ç•¶åœ°ä»˜ç¾</p>
                        </div>
                        <div className="flex-1 bg-gradient-to-br from-purple-400 to-purple-600 p-3 rounded-xl text-white shadow">
                            <p className="text-xs opacity-90 font-bold">ğŸ’³ åˆ·å¡ç¸½æ”¯å‡º (TWD)</p>
                            <p className="text-xl font-black">${stats.displayCardTotalTWD.toLocaleString()}</p>
                            <p className="text-[10px] opacity-80">Â¥{stats.cardTotalJPY.toLocaleString()} + ${stats.cardTotalTWD.toLocaleString()}</p>
                        </div>
                    </div>

                    {/* Split Bill */}
                    <div className="bg-orange-50 border border-orange-200 rounded-xl p-3 shadow-sm">
                        <h3 className="font-bold text-orange-800 text-sm mb-2">âš–ï¸ çµç®— (AAåˆ¶)</h3>
                        <div className="text-sm space-y-2">
                            <div className="flex justify-between border-b border-orange-200 pb-1">
                                <span>ğŸ’´ æ—¥å¹£:</span>
                                {stats.diffJpy === 0 ? <span className="text-green-600">å…©æ¸…</span> : (
                                    stats.diffJpy > 0 ? <span className="text-pink-600 font-bold">ğŸ‘©çµ¦ğŸ‘¦ Â¥{Math.round(stats.diffJpy).toLocaleString()}</span> : <span className="text-blue-600 font-bold">ğŸ‘¦çµ¦ğŸ‘§ Â¥{Math.round(Math.abs(stats.diffJpy)).toLocaleString()}</span>
                                )}
                            </div>
                            <div className="flex justify-between">
                                <span>ğŸ’³ å°å¹£:</span>
                                {stats.diffTwd === 0 ? <span className="text-green-600">å…©æ¸…</span> : (
                                    stats.diffTwd > 0 ? <span className="text-pink-600 font-bold">ğŸ‘©çµ¦ğŸ‘¦ ${Math.round(stats.diffTwd).toLocaleString()}</span> : <span className="text-blue-600 font-bold">ğŸ‘¦çµ¦ğŸ‘§ ${Math.round(Math.abs(stats.diffTwd)).toLocaleString()}</span>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* List */}
                    <div className="space-y-2">
                        {expenses.slice().reverse().map(ex => (
                            <div key={ex.id} className="bg-white/95 rounded-lg p-3 shadow flex justify-between items-center border border-gray-100">
                                <div>
                                    <p className="font-bold text-gray-800">{ex.title}</p>
                                    <div className="flex gap-2 mt-1">
                                        <span className={`text-[10px] px-1.5 rounded ${ex.payer === 'boy' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600'}`}>{ex.payer==='boy'?'ğŸ‘¦ç”·å‹':'ğŸ‘§å¥³å‹'}</span>
                                        <span className={`text-[10px] px-1.5 rounded ${ex.method === 'card' ? 'bg-purple-100 text-purple-600' : 'bg-green-100 text-green-600'}`}>{ex.method==='card'?'ğŸ’³åˆ·å¡':'ğŸ’µç¾é‡‘'}</span>
                                        <span className="text-[10px] text-gray-400 bg-gray-100 px-1.5 rounded">{ex.category}</span>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="font-mono font-bold text-lg text-gray-700">
                                        {ex.currency === 'jpy' ? 'Â¥' : '$'}{Number(ex.amount).toLocaleString()}
                                    </span>
                                    <button onClick={() => removeExpense(ex.id)} className="text-gray-300 hover:text-red-500"><Icon name="trash-2" size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // 3. Utility Tab (Updated)
        const UtilityTab = ({ resetData, exportData, importData }) => {
            const [activeCard, setActiveCard] = useState(null);
            const fileInputRef = useRef(null);

            return (
                <div className="pb-24 relative z-10 px-2 space-y-4">
                    <div className="grid grid-cols-2 gap-3">
                        {translationCards.map((card, idx) => (
                            <button key={idx} onClick={() => setActiveCard(card)} className={`p-4 rounded-xl shadow text-white text-left transition transform active:scale-95 ${card.color}`}>
                                <p className="text-xs opacity-80 mb-1">{card.cat}</p>
                                <p className="text-lg font-bold">{card.zh}</p>
                            </button>
                        ))}
                    </div>

                    {activeCard && (
                        <div className="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-8 text-center cursor-pointer animate-fade-in" onClick={() => setActiveCard(null)}>
                            <span className={`text-white px-4 py-1 rounded-full mb-8 ${activeCard.color}`}>{activeCard.cat}</span>
                            <h1 className="text-gray-900 font-black text-5xl leading-tight mb-4">{activeCard.jp}</h1>
                            <p className="text-gray-400 text-xl font-mono">{activeCard.py}</p>
                            <p className="text-gray-300 text-sm mt-12">(é»æ“Šé—œé–‰)</p>
                        </div>
                    )}

                    <div className="bg-white/90 rounded-2xl p-4 shadow-lg border-t-4 border-yellow-500">
                        <h3 className="font-bold text-gray-800 mb-2 flex items-center gap-2"><Icon name="save" size={16} /> é›»è…¦å‚™ä»½å€</h3>
                        <div className="flex gap-2">
                            <button onClick={exportData} className="flex-1 bg-[#0096FF] text-white p-2 rounded text-sm font-bold flex justify-center gap-2"><Icon name="download" size={14} /> åŒ¯å‡ºå‚™ä»½</button>
                            <button onClick={() => fileInputRef.current.click()} className="flex-1 bg-green-600 text-white p-2 rounded text-sm font-bold flex justify-center gap-2"><Icon name="upload" size={14} /> åŒ¯å…¥é‚„åŸ</button>
                            <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={importData} />
                        </div>
                    </div>
                    <div className="text-center"><button onClick={resetData} className="text-xs text-gray-400 underline">é‡ç½®æ‰€æœ‰è³‡æ–™</button></div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('schedule');
            const [schedule, setSchedule] = useStickyState(initialSchedule, 'hk_v10_schedule'); 
            const [expenses, setExpenses] = useStickyState([], 'hk_v10_expenses');

            const handleReset = () => { if (confirm("é‡ç½®å°‡åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ")) { localStorage.clear(); window.location.reload(); } };
            const handleExport = () => {
                const blob = new Blob([JSON.stringify({ schedule, expenses })], { type: "application/json" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `hokkaido_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if(confirm("ç¢ºå®šé‚„åŸå‚™ä»½ï¼Ÿç›®å‰è³‡æ–™å°‡è¢«è¦†è“‹ã€‚")) {
                            if(data.schedule) setSchedule(data.schedule);
                            if(data.expenses) setExpenses(data.expenses);
                            alert("é‚„åŸæˆåŠŸï¼");
                        }
                    } catch (err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            return (
                <div className="min-h-screen pb-20 max-w-md mx-auto relative bg-[#FFF0F5] shadow-2xl min-h-screen overflow-hidden">
                    <SakuraBg />
                    <header className="sticky top-0 z-40 bg-gradient-to-r from-[#0096FF] to-[#FB6F92] text-white p-4 shadow-md flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-2xl border-2 border-[#0096FF]">ğŸ‚</div>
                            <div><h1 className="font-bold text-lg">åŒ—æµ·é“ä»»æ„é–€</h1><p className="text-[10px] opacity-90">V10 é›»è…¦ç‰ˆ</p></div>
                        </div>
                        <div className="text-xs bg-white/20 px-2 py-1 rounded">4/22 - 4/28</div>
                    </header>

                    <main className="pt-4">
                        {activeTab === 'schedule' && <ScheduleTab data={schedule} setData={setSchedule} />}
                        {activeTab === 'budget' && <BudgetTab expenses={expenses} setExpenses={setExpenses} />}
                        {activeTab === 'utility' && <UtilityTab resetData={handleReset} exportData={handleExport} importData={handleImport} />}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50 max-w-md mx-auto flex justify-around p-2 pb-4">
                        <button onClick={() => setActiveTab('schedule')} className={`flex flex-col items-center w-16 ${activeTab === 'schedule' ? 'text-[#0096FF]' : 'text-gray-400'}`}><Icon name="calendar" /><span className="text-[10px] font-bold">è¡Œç¨‹</span></button>
                        <button onClick={() => setActiveTab('budget')} className={`flex flex-col items-center w-16 ${activeTab === 'budget' ? 'text-[#0096FF]' : 'text-gray-400'}`}><Icon name="wallet" /><span className="text-[10px] font-bold">è¨˜å¸³</span></button>
                        <button onClick={() => setActiveTab('utility')} className={`flex flex-col items-center w-16 ${activeTab === 'utility' ? 'text-[#0096FF]' : 'text-gray-400'}`}><Icon name="backpack" /><span className="text-[10px] font-bold">ç™¾å¯¶è¢‹</span></button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>